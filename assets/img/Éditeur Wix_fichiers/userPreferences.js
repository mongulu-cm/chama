define("userPreferences",["lodash","jquery","util","pLoader!santa:utils"],function(a,b,c,d){"use strict";function f(){function h(){return c.url.isTrue("fakeUserPrefs")}function i(a){var b=c.url.getParameterByName("resetUserPrefs").toLowerCase();return"all"===b||b===a}function j(b,c){switch(b){case g.global.id:return c.global_preferences;case g.site.id:return a.mapValues(c,function(a){return{value:a,isDirty:!1}});default:return d.log.error("unknown type ID"),{}}}function k(a,b){g.global.data={},u(g.global.id,a,b)}function l(b,c){a.forEach(g.site.data,function(a){a.value=null,a.isDirty=!0}),u(g.site.id,b,c)}function m(b){var c={nameSpace:"htmlEditor",siteId:f,data:{}};return a.forEach(b,function(a,b){a.isDirty&&(c.data[b]=a.value)}),c}function n(a){return{nameSpace:"htmlEditor",key:"global_preferences",blob:a}}function o(a){switch(a){case g.global.id:return n(g.global.data);case g.site.id:return m(g.site.data)}}function p(b){switch(b){case g.global.id:return{global_preferences:g.global.data};case g.site.id:var c={};return a.forEach(g.site.data,function(a,b){c[b]=a.value}),c;default:return d.log.error("unknown type ID"),{}}}function q(a,b,c,d){g[a].data=b?j(a,b):{},i(a)?t(a,c,d):c&&c()}function r(b){b===g.site.id&&a.forEach(g.site.data,function(a){a.isDirty=!1})}function s(a,c,d){if(h()){var e=window.sessionStorage.getItem("user_prefs_"+g[a].id);return void q(a,JSON.parse(e),c,d)}b.ajax(g[a].urls.getLoadUrl(),{type:"GET",success:function(b){q(a,b,c,d)},error:function(a){d&&d(a)}})}function t(a,b,c){switch(a){case g.global.id:return k(b,c);case g.site.id:return l(b,c)}}function u(a,c,d){if(null===g[a].data)return void(d&&d("saving "+a+" preferences failed since they were not loaded"));if(h()){var e=p(a);return window.sessionStorage.setItem("user_prefs_"+g[a].id,JSON.stringify(e)),r(a),void(c&&c())}b.ajax(g[a].urls.getSaveUrl(),{type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify(o(a)),success:function(){r(a),c&&c()},error:function(a){d&&d(a)}})}function v(b,c){function e(a){function e(){if(a&&a.responseText){var b=a.responseText.match(/errorCode="(\d+)"/);return b=b&&b[1],"3001"===b}return!1}return e()?(g.global.data={},void b()):(g.global.data=null,d.log.error("Global preferences failed to load!"),void c("Global preferences failed to load!"))}b=b||a.noop,c=c||a.noop,s(g.global.id,b,e)}function w(b,c,e,h){var i=a.isEmpty(g.site.data);if(f=b,c)i||u(g.site.id,e,h);else if(i)s(g.site.id,e,function(){d.log.error("Site preferences failed to load!"),h&&h("Site preferences failed to load!")});else{var j=a.clone(g.site.data),k=u.bind(this,g.site.id,e,h),l=function(){g.site.data=a.merge(g.site.data,j),k()};s(g.site.id,l,function(){d.log.error("Site preferences failed to load!"),k()})}}var f=null,g={session:{id:"session",data:{}},site:{id:"site",data:{},urls:{getLoadUrl:function(){return e+"getVolatilePrefsForSite/htmlEditor/"+f},getSaveUrl:function(){return e+"bulkSet"}}},global:{id:"global",data:null,urls:{getLoadUrl:function(){return e+"getVolatilePrefForKey/htmlEditor/global_preferences"},getSaveUrl:function(){return e+"set"}}}};return{loadGlobalPreferences:v,loadSitePreferences:w,global:{get:function(b){if(null===g.global.data)return d.log.error("Global user preferences failed to load!"),null;if(!a.isString(b))throw new Error("Getting a global user preference expects a key of type string but received: "+b);return a.cloneDeep(g.global.data[b])},getAll:function(){return null===g.global.data?(d.log.error("Global user preferences failed to load!"),null):a.cloneDeep(g.global.data)},set:function(b,c,e,f){if(null===g.global.data)return d.log.error("Global user preferences failed to load!"),void(f&&f("Global user preferences failed to load!"));if(!a.isString(b))throw new Error("Setting a global user preference expects a key of type string but received: "+b);a.isUndefined(c)&&(c=null),g.global.data[b]=c,u(g.global.id,e,f)}},site:{get:function(b){if(!a.isString(b))throw new Error("Getting a user preference for the site expects a key of type string but received: "+b);return a.cloneDeep(g.site.data[b]&&g.site.data[b].value)},getAll:function(){return a.cloneDeep(a.mapValues(g.site.data,"value"))},set:function(b,c,d,e){if(!a.isString(b))throw new Error("Setting a user preference for the site expects a key of type string but received: "+b);a.isUndefined(c)&&(c=null);var h={value:c,isDirty:!0};g.site.data[b]=h,f?u(g.site.id,d,e):d&&d()}},session:{get:function(b){if(!a.isString(b))throw new Error("Getting a session user preference expects a key of type string but received: "+b);return a.cloneDeep(g.session.data[b])},getAll:function(){return a.cloneDeep(g.session.data)},set:function(b,c,d){if(!a.isString(b))throw new Error("Setting a session user preference expects a key of type string but received: "+b);return g.session.data[b]=c,d&&d(),c}}}}var e=c.serviceTopology.premiumStateApiUrl;return e=e?e.replace(/\/getTpaPremiumState/,"-user-preferences-webapp/"):"http://editor.wix.com/_api/wix-user-preferences-webapp/",f});